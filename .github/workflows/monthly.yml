name: Monthly Heartbeat

on:
  schedule:
    - cron: '0 12 1,15 * *'
  workflow_dispatch:
    inputs:
      month:
        description: 'Target month YYYY-MM (default: previous month)'
        required: false
      model:
        description: 'Claude model'
        required: false
        type: choice
        options:
          - claude-sonnet-4-5-20250929
          - claude-opus-4-6
        default: claude-opus-4-6

jobs:
  digest:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate target month
        id: month
        run: |
          if [ -n "${{ github.event.inputs.month }}" ]; then
            echo "target=${{ github.event.inputs.month }}" >> "$GITHUB_OUTPUT"
          else
            echo "target=$(date -u -d 'last month' +%Y-%m)" >> "$GITHUB_OUTPUT"
          fi

      - name: Create MCP configuration
        run: |
          cat > /tmp/mcp-config.json << EOF
          {
            "mcpServers": {
              "regen-koi": {
                "command": "npx",
                "args": ["-y", "regen-koi-mcp@latest"],
                "env": {
                  "KOI_API_ENDPOINT": "${{ secrets.KOI_API_ENDPOINT }}"
                }
              }
            }
          }
          EOF

      - name: Generate monthly digest
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Generate a monthly digest for the Regen ecosystem.
            Read and follow ALL instructions in: .claude/agents/monthly-digest.md
            Target month: ${{ steps.month.outputs.target }}
            IMPORTANT: This is an automated workflow. Complete autonomously.
            CRITICAL: You MUST use the Bash tool to write files. The Write tool does NOT persist to the filesystem in this CI environment. Use Bash with mkdir -p and cat heredoc (cat > path << 'DIGESTEOF' ... DIGESTEOF) to write the digest file to content/digests/. Always verify with ls that the file exists after writing.
          claude_args: |
            --model ${{ github.event.inputs.model || 'claude-opus-4-6' }}
            --max-turns 100
            --mcp-config /tmp/mcp-config.json
            --dangerously-skip-permissions

      - name: Commit and push
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git config user.name "regen-heartbeat[bot]"
          git config user.email "heartbeat@regen.network"
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git"
          git add content/digests/
          git diff --cached --quiet || \
            (git commit -m "monthly: ${{ steps.month.outputs.target }}" && git push)
